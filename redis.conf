# Redis configuration file for FastAPI Finance Monitor
# Версия: 1.0
# Назначение: кэширование временных финансовых данных (котировки, индикаторы, метаданные)
# Рекомендуется использовать в связке с Docker или в изолированной среде

# ======
# СЕТЬ #
# ======
# Слушать все интерфейсы (в Docker — безопасно; в публичной сети — опасно!)
bind 0.0.0.0

# Порт по умолчанию
port 6379

# Отключить таймаут соединения (клиенты могут держать соединение долго)
timeout 0

# Периодичность проверки активности соединения (в секундах)
tcp-keepalive 300

# =================
# ОБЩИЕ НАСТРОЙКИ #
# =================
# Не запускать как демон (обязательно для Docker)
daemonize no

# Не использовать системный супервизор (systemd и т.п.)
supervised no

# Уровень логирования: debug, verbose, notice, warning
loglevel notice

# Логировать в stdout/stderr (удобно для контейнеров)
logfile ""

# ======================================
# ПЕРСИСТЕНТНОСТЬ (СОХРАНЕНИЕ НА ДИСК) #
# ======================================
# Отключаем RDB-снапшоты — данные временные и восстанавливаются из API
save ""

# Не блокировать запись при ошибке сохранения (т.к. сохранение не используется)
stop-writes-on-bgsave-error no

# Сжатие RDB-файлов (актуально, если включите save позже)
rdbcompression yes

# Контрольная сумма для целостности RDB
rdbchecksum yes

# Имя файла снапшота
dbfilename dump.rdb

# Каталог для сохранения данных — используйте абсолютный путь!
# В Docker-образе Redis стандартный путь — /data
dir /data

# ==============
# БЕЗОПАСНОСТЬ #
# ==============
# Защитный режим: если нет пароля и bind не 127.0.0.1 — принимать подключения только от localhost
# В Docker-сети это безопасно, т.к. сеть изолирована
protected-mode yes

# Пароль для доступа к Redis (раскомментируйте и задайте надёжный пароль в продакшене!)
# requirepass your_strong_redis_password_here

# ======================
# ОГРАНИЧЕНИЯ РЕСУРСОВ #
# ======================
# Максимальное число клиентских подключений
maxclients 1000

# Лимит памяти — увеличен до 512 МБ для надёжной работы с множеством тикеров
maxmemory 512mb

# Политика вытеснения ключей при превышении лимита памяти:
# allkeys-lru — удалять наименее недавно используемые ключи (подходит для кэша)
maxmemory-policy allkeys-lru

# Точность выбора жертвы для LRU (чем выше — точнее, но дороже)
maxmemory-samples 5

# ====================================
# APPEND-ONLY FILE (AOF) — ОТКЛЮЧЕНО #
# ====================================
# AOF обеспечивает лучшую устойчивость к сбоям, но замедляет работу.
# Для временного кэша финансовых данных не требуется.
appendonly no

# Если включите AOF, рекомендуется:
# appendfilename "appendonly.aof"
# appendfsync everysec
# no-appendfsync-on-rewrite no
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb
# aof-load-truncated yes

# ==============================
# СКРИПТЫ И ПРОИЗВОДИТЕЛЬНОСТЬ #
# ==============================
# Максимальное время выполнения Lua-скрипта (в миллисекундах)
lua-time-limit 5000

# =============
# ДИАГНОСТИКА #
# =============
# Логировать команды, выполнявшиеся дольше N микросекунд (10000 = 10 мс)
slowlog-log-slower-than 10000

# Максимальное число записей в slowlog
slowlog-max-len 128

# Порог для мониторинга задержек (в миллисекундах). 0 = отключено.
latency-monitor-threshold 0

# События keyspace (используются для подписок). Пусто = отключено.
notify-keyspace-events ""

# =========================================================================
# ОПТИМИЗАЦИИ СТРУКТУР ДАННЫХ (по умолчанию — хороши для мелких значений) #
# =========================================================================
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
activerehashing yes

# ========================
# БУФЕРЫ ВЫВОДА КЛИЕНТОВ #
# ========================
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Частота фоновых операций (по умолчанию — 10)
hz 10

# Использовать инкрементальную fsync при перезаписи AOF (если AOF включён)
aof-rewrite-incremental-fsync yes

# ===============================================================
# РЕПЛИКАЦИЯ — ОТКЛЮЧЕНА (не используется в одиночном инстансе) #
# ===============================================================
# Все параметры репликации удалены или неактивны по умолчанию в Redis 7+
# Если понадобится — настраивайте отдельно.